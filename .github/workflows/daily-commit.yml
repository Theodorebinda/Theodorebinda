name: Fun Daily Commit 🚀

on:
  schedule:
    - cron: '0 2 * * *' # Tous les jours à minuit UTC
  workflow_dispatch:

jobs:
  daily_fun:
    runs-on: ubuntu-latest

    steps:
      - name: 🛎️ Checkout du dépôt
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: 📦 Installer jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ⚙️ Configurer Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: 🔄 Tirer les dernières modifications
        run: git pull origin main --rebase

      - name: ✍️ Générer et insérer la citation dans README
        run: |
          set +e

          # Compteur basé sur README
          if grep -q "Jour [0-9]\+" README.md; then
            last_count=$(grep -oE 'Jour [0-9]+' README.md | tail -n 1 | grep -oE '[0-9]+' || echo 0)
            count=$((last_count + 1))
          else
            count=1
          fi

          # Emojis
          emojis=("🚀" "🔥" "🌞" "🎉" "✨" "🌈" "💡" "🧠" "🌍" "💻" "☕" "📚" "🌱")
          emoji=${emojis[$((RANDOM % ${#emojis[@]}))]}

          # Citation (fallback si API KO)
          quote=$(curl -s https://api.quotable.io/random | jq -r '.content + " — " + .author' || echo "Reste motivé et continue — Inconnu")

          # Texte à insérer
          new_block="<!--START_QUOTE-->\nJour $count $emoji - $(date '+%d %B %Y')\n\n💬 \"$quote\"\n<!--END_QUOTE-->"

          # Remplacer dans README
          sed -i "/<!--START_QUOTE-->/, /<!--END_QUOTE-->/c$new_block" README.md

      - name: 💾 Commit & Push
        run: |
          git add README.md
          git commit -m "✨ Jour $count - Mise à jour citation quotidienne" || echo "Rien à committer"
          git push origin main
